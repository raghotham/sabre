name: Deploy SABRE Server to AWS App Runner

on:
  push:
    branches: [main]
    paths:
      - 'sabre/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  APP_RUNNER_SERVICE_NAME: sabre-server

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to App Runner
        run: |
          # Check if service exists
          if aws apprunner list-services --region ${{ env.AWS_REGION }} \
             | jq -e ".ServiceSummaryList[] | select(.ServiceName==\"${{ env.APP_RUNNER_SERVICE_NAME }}\")"; then
            echo "Service exists, updating..."

            # Get service ARN
            SERVICE_ARN=$(aws apprunner list-services --region ${{ env.AWS_REGION }} \
              | jq -r ".ServiceSummaryList[] | select(.ServiceName==\"${{ env.APP_RUNNER_SERVICE_NAME }}\") | .ServiceArn")

            # Trigger deployment by updating service
            aws apprunner start-deployment \
              --service-arn $SERVICE_ARN \
              --region ${{ env.AWS_REGION }}

            echo "Deployment started for service: $SERVICE_ARN"
          else
            echo "Service doesn't exist, creating..."

            # Create IAM role for App Runner to access ECR
            ROLE_NAME="AppRunnerECRAccessRole"

            # Check if role exists
            if ! aws iam get-role --role-name $ROLE_NAME 2>/dev/null; then
              echo "Creating IAM role for App Runner ECR access..."

              # Create trust policy
              cat > /tmp/trust-policy.json <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [{
              "Effect": "Allow",
              "Principal": {
                "Service": "build.apprunner.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }]
          }
          EOF

              # Create role
              aws iam create-role \
                --role-name $ROLE_NAME \
                --assume-role-policy-document file:///tmp/trust-policy.json \
                --description "Allows App Runner to access ECR"

              # Attach ECR read-only policy
              aws iam attach-role-policy \
                --role-name $ROLE_NAME \
                --policy-arn arn:aws:iam::aws:policy/service-role/AWSAppRunnerServicePolicyForECRAccess

              # Wait for role to propagate
              sleep 10
            fi

            # Get role ARN
            ROLE_ARN=$(aws iam get-role --role-name $ROLE_NAME --query 'Role.Arn' --output text)
            echo "Using IAM role: $ROLE_ARN"

            # Create ECR repository if it doesn't exist
            aws ecr create-repository --repository-name sabre-server --region ${{ env.AWS_REGION }} || true

            # Get ECR repository URI
            ECR_URI=$(aws ecr describe-repositories --repository-names sabre-server --region ${{ env.AWS_REGION }} \
              | jq -r '.repositories[0].repositoryUri')

            # Build and push Docker image
            aws ecr get-login-password --region ${{ env.AWS_REGION }} \
              | docker login --username AWS --password-stdin $ECR_URI

            docker build -t sabre-server .
            docker tag sabre-server:latest $ECR_URI:latest
            docker push $ECR_URI:latest

            # Create App Runner service
            aws apprunner create-service \
              --service-name ${{ env.APP_RUNNER_SERVICE_NAME }} \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "'$ECR_URI':latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "8011",
                    "RuntimeEnvironmentVariables": {
                      "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}"
                    }
                  }
                },
                "AuthenticationConfiguration": {
                  "AccessRoleArn": "'$ROLE_ARN'"
                },
                "AutoDeploymentsEnabled": true
              }' \
              --instance-configuration '{
                "Cpu": "1024",
                "Memory": "2048"
              }' \
              --health-check-configuration '{
                "Protocol": "HTTP",
                "Path": "/health",
                "Interval": 10,
                "Timeout": 5,
                "HealthyThreshold": 1,
                "UnhealthyThreshold": 5
              }' \
              --region ${{ env.AWS_REGION }}

            echo "Service created successfully"
          fi

      - name: Wait for deployment
        run: |
          SERVICE_ARN=$(aws apprunner list-services --region ${{ env.AWS_REGION }} \
            | jq -r ".ServiceSummaryList[] | select(.ServiceName==\"${{ env.APP_RUNNER_SERVICE_NAME }}\") | .ServiceArn")

          echo "Waiting for deployment to complete..."
          aws apprunner wait service-running \
            --service-arn $SERVICE_ARN \
            --region ${{ env.AWS_REGION }}

          echo "Deployment complete!"

          # Get service URL
          SERVICE_URL=$(aws apprunner describe-service \
            --service-arn $SERVICE_ARN \
            --region ${{ env.AWS_REGION }} \
            | jq -r '.Service.ServiceUrl')

          echo "Service URL: https://$SERVICE_URL"
