<!DOCTYPE html>
<html>
<head>
    <title>SABRE Conversations</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }
        .header {
            background: #252526;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
        }
        h1 {
            color: #4ec9b0;
            margin: 0;
            font-size: 24px;
        }
        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 56px);
            gap: 0;
        }
        .sidebar {
            background: #252526;
            border-right: 1px solid #3e3e42;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            color: #cccccc;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .conversation-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            background: #2d2d30;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .conversation-item:hover {
            background: #37373d;
        }
        .conversation-item.selected {
            background: #37373d;
            border-left-color: #4ec9b0;
        }
        .conversation-id {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #4ec9b0;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .conversation-meta {
            color: #858585;
            font-size: 11px;
            margin-top: 5px;
        }
        .conversation-preview {
            color: #b0b0b0;
            font-size: 12px;
            margin-top: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .main-panel {
            background: #1e1e1e;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .conversation-header {
            background: #252526;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .conversation-title {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #4ec9b0;
            font-size: 14px;
            margin: 0;
        }
        .conversation-content {
            flex: 1;
            padding: 20px;
        }
        .turn {
            margin-bottom: 20px;
            padding: 15px;
            background: #252526;
            border-radius: 4px;
        }
        .turn.user {
            border-left: 4px solid #569cd6;
        }
        .turn.assistant {
            border-left: 4px solid #4ec9b0;
        }
        .turn-role {
            font-weight: bold;
            color: #4ec9b0;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-size: 12px;
        }
        .turn.user .turn-role {
            color: #569cd6;
        }
        .turn-content {
            color: #d4d4d4;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #858585;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #858585;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SABRE Conversations</h1>
    </div>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">Conversations</div>
            <div id="conversationsList" class="conversations-list">
                <div class="loading">Loading conversations...</div>
            </div>
        </div>

        <div class="main-panel">
            <div id="mainContent">
                <div class="empty-state">Select a conversation to view details</div>
            </div>
        </div>
    </div>

    <script>
        let conversations = [];
        let selectedConversationId = null;

        async function loadConversations() {
            try {
                const response = await fetch('/v1/conversations');
                const data = await response.json();
                conversations = data.conversations;
                renderConversations();
            } catch (error) {
                document.getElementById('conversationsList').innerHTML =
                    '<div class="loading">Error loading conversations</div>';
            }
        }

        function renderConversations() {
            const list = document.getElementById('conversationsList');
            if (conversations.length === 0) {
                list.innerHTML = '<div class="loading">No conversations yet</div>';
                return;
            }

            list.innerHTML = conversations.map(conv => {
                const isSelected = conv.conversation_id === selectedConversationId;
                return `
                    <div class="conversation-item ${isSelected ? 'selected' : ''}" onclick="viewConversation('${conv.conversation_id}')">
                        <div class="conversation-id">${conv.conversation_id}</div>
                        ${conv.preview ? `<div class="conversation-preview">${escapeHtml(conv.preview)}</div>` : ''}
                        <div class="conversation-meta">
                            ${conv.event_count} events â€¢ Started: ${new Date(conv.start_time).toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function viewConversation(conversationId, pushState = true) {
            // Update selected conversation
            selectedConversationId = conversationId;
            renderConversations(); // Re-render to show selected state

            // Update URL
            if (pushState) {
                history.pushState(
                    { conversationId },
                    '',
                    `/?conversation=${conversationId}`
                );
            }

            // Show loading in main panel
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="conversation-header">
                    <h2 class="conversation-title">${conversationId}</h2>
                </div>
                <div class="conversation-content">
                    <div class="loading">Loading conversation...</div>
                </div>
            `;

            try {
                // Fetch conversation messages from logged files
                const response = await fetch(`/v1/conversations/${conversationId}/turns`);
                const data = await response.json();
                renderMessages(data.messages, conversationId);
            } catch (error) {
                console.error('Error loading conversation:', error);
                mainContent.innerHTML = `
                    <div class="conversation-header">
                        <h2 class="conversation-title">${conversationId}</h2>
                    </div>
                    <div class="conversation-content">
                        <div class="loading">Error loading conversation</div>
                    </div>
                `;
            }
        }

        function renderMessages(messages, conversationId) {
            const mainContent = document.getElementById('mainContent');

            if (!messages || messages.length === 0) {
                mainContent.innerHTML = `
                    <div class="conversation-header">
                        <h2 class="conversation-title">${conversationId}</h2>
                    </div>
                    <div class="conversation-content">
                        <div class="loading">No messages in this conversation</div>
                    </div>
                `;
                return;
            }

            const messagesHtml = messages.map(msg => {
                let content = msg.content;

                // Extract and render images from markdown image syntax: ![alt](url)
                // or bare URLs pointing to /v1/files/
                const imageUrls = [];

                // Match markdown images: ![...](http://...)
                const markdownImageRegex = /!\[([^\]]*)\]\((http:\/\/[^)]+)\)/g;
                let match;
                while ((match = markdownImageRegex.exec(content)) !== null) {
                    imageUrls.push({ url: match[2], alt: match[1] });
                }

                // Also match bare URLs that look like file URLs
                const bareUrlRegex = /(http:\/\/[^\s]+\/v1\/files\/[^\s]+)/g;
                while ((match = bareUrlRegex.exec(content)) !== null) {
                    // Only add if not already in imageUrls
                    if (!imageUrls.find(img => img.url === match[1])) {
                        imageUrls.push({ url: match[1], alt: '' });
                    }
                }

                // Remove image markdown syntax from text content
                let textContent = content.replace(/!\[([^\]]*)\]\((http:\/\/[^)]+)\)/g, '');
                // Remove bare file URLs
                textContent = textContent.replace(/(http:\/\/[^\s]+\/v1\/files\/[^\s]+)/g, '');

                // Build HTML
                let html = `
                    <div class="turn ${msg.role}">
                        <div class="turn-role">${msg.role}</div>
                        <div class="turn-content">${escapeHtml(textContent)}</div>
                `;

                // Add images
                if (imageUrls.length > 0) {
                    html += '<div style="margin-top: 10px;">';
                    imageUrls.forEach(img => {
                        html += `<img src="${img.url}" alt="${escapeHtml(img.alt)}" style="max-width: 100%; height: auto; margin: 5px 0; border-radius: 4px;">`;
                    });
                    html += '</div>';
                }

                html += '</div>';
                return html;
            }).join('');

            mainContent.innerHTML = `
                <div class="conversation-header">
                    <h2 class="conversation-title">${conversationId}</h2>
                </div>
                <div class="conversation-content">
                    ${messagesHtml}
                </div>
            `;
        }

        function clearSelection(pushState = true) {
            // Update URL to remove conversation parameter
            if (pushState) {
                history.pushState({}, '', '/');
            }

            selectedConversationId = null;
            renderConversations();
            document.getElementById('mainContent').innerHTML = '<div class="empty-state">Select a conversation to view details</div>';
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            const urlParams = new URLSearchParams(window.location.search);
            const conversationId = urlParams.get('conversation');

            if (conversationId) {
                viewConversation(conversationId, false);
            } else {
                clearSelection(false);
            }
        });

        // Check URL on page load for direct links
        async function initializeApp() {
            await loadConversations();

            // Check if URL has a conversation parameter
            const urlParams = new URLSearchParams(window.location.search);
            const conversationId = urlParams.get('conversation');

            if (conversationId) {
                viewConversation(conversationId, false);
            }
        }

        // Initialize app
        initializeApp();

        // Auto-refresh conversations list every 10 seconds (preserves selection)
        setInterval(() => {
            loadConversations();
        }, 10000);
    </script>
</body>
</html>
