<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABRE Session Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 300px;
            background: #222;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .sidebar-header h2 {
            font-size: 18px;
            color: white;
            margin-bottom: 5px;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
        }

        .session-item {
            padding: 15px 20px;
            border-bottom: 1px solid #2a2a2a;
            cursor: pointer;
            transition: background 0.2s;
        }

        .session-item:hover {
            background: #2a2a2a;
        }

        .session-item.active {
            background: #333;
            border-left: 3px solid #667eea;
        }

        .session-item-time {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .session-item-preview {
            font-size: 13px;
            color: #ccc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-item-id {
            font-size: 10px;
            color: #666;
            font-family: 'Monaco', 'Courier New', monospace;
            margin-top: 5px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: white;
        }

        .header .meta {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        .session-selector {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .session-selector label {
            display: block;
            margin-bottom: 10px;
            color: #888;
            font-size: 14px;
        }

        .session-selector input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .session-selector button {
            margin-top: 10px;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .session-selector button:hover {
            background: #5568d3;
        }

        .stats {
            background: #2a2a2a;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .stat-item {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .stat-item .label {
            font-size: 12px;
            color: #888;
        }

        .stat-item .value {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }

        .table-container {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .execution-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .execution-table thead {
            background: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .execution-table th {
            padding: 12px 10px;
            text-align: left;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            border-bottom: 2px solid #333;
        }

        .execution-table th:nth-child(1) { width: 90px; }  /* Timestamp */
        .execution-table th:nth-child(2) { width: 200px; } /* Node */
        .execution-table th:nth-child(3) { width: 80px; }  /* Status */
        .execution-table th:nth-child(4) { width: 120px; } /* Usage */
        .execution-table th:nth-child(5) { min-width: 300px; } /* Content */
        .execution-table th:nth-child(6) { min-width: 200px; } /* Output */

        .execution-table tbody tr {
            border-bottom: 1px solid #333;
            transition: background 0.15s;
            position: relative;
        }

        .execution-table tbody tr:hover {
            background: #2f2f2f;
        }

        .execution-table tbody tr.depth-0 {
            background: rgba(102, 126, 234, 0.03);
        }

        .execution-table tbody tr.depth-1 {
            background: rgba(102, 126, 234, 0.05);
        }

        .execution-table tbody tr.depth-2 {
            background: rgba(102, 126, 234, 0.07);
        }

        .execution-table tbody tr.depth-3 {
            background: rgba(102, 126, 234, 0.09);
        }

        .execution-table td {
            padding: 12px 10px;
            vertical-align: top;
        }

        .node-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .tree-lines {
            display: flex;
            align-items: center;
            position: relative;
            height: 100%;
        }

        .tree-connector {
            position: relative;
            width: 20px;
            height: 30px;
            display: flex;
            align-items: center;
        }

        .tree-connector::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 2px;
            height: 50%;
            background: #555;
        }

        .tree-connector::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background: #555;
        }

        .tree-vertical {
            position: absolute;
            left: 1px;
            top: -15px;
            width: 2px;
            height: calc(100% + 15px);
            background: #555;
        }

        .node-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .node-type-badge.user {
            background: #667eea;
            color: white;
        }

        .node-type-badge.response {
            background: #9b59b6;
            color: white;
        }

        .node-type-badge.helper {
            background: #3498db;
            color: white;
        }

        .screenshot-container {
            margin: 10px 0;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
            border: 1px solid #444;
        }

        .screenshot-image {
            max-width: 100%;
            height: auto;
            border-radius: 3px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .screenshot-image:hover {
            transform: scale(1.02);
        }

        .system-prompt-section {
            margin-top: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #1a1a1a;
        }

        .system-prompt-summary {
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
            background: #252525;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-prompt-summary:hover {
            background: #2a2a2a;
        }

        .prompt-label {
            font-weight: bold;
            color: #3498db;
            font-size: 12px;
        }

        .prompt-preview {
            color: #888;
            font-size: 11px;
            font-family: 'Monaco', 'Courier New', monospace;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .system-prompt-content {
            padding: 12px;
            background: #1a1a1a;
            border-top: 1px solid #444;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #ddd;
            max-height: 400px;
            overflow-y: auto;
        }

        .node-id {
            font-family: 'Monaco', 'Courier New', monospace;
            color: #888;
            font-size: 11px;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-badge.success {
            background: #2ecc71;
            color: white;
        }

        .status-badge.error {
            background: #e74c3c;
            color: white;
        }

        .status-badge.pending {
            background: #95a5a6;
            color: white;
        }

        .usage-cell {
            font-size: 11px;
            line-height: 1.5;
        }

        .usage-label {
            color: #888;
        }

        .usage-value {
            color: #667eea;
            font-weight: bold;
        }

        .content-cell {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 150px;
            overflow-y: auto;
            color: #e0e0e0;
        }

        .code-content {
            background: #1e1e1e;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        .output-cell {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 150px;
            overflow-y: auto;
        }

        .output-content {
            background: #1e1e1e;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #2ecc71;
            color: #2ecc71;
        }

        .error-content {
            background: #2a1a1a;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #e74c3c;
            color: #e74c3c;
        }

        .table-scroll {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }


        .error-message {
            background: #2a1a1a;
            border: 1px solid #e74c3c;
            padding: 20px;
            border-radius: 8px;
            color: #e74c3c;
            margin: 20px 0;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>SABRE Viewer</h2>
                <div class="subtitle" id="session-count">Loading sessions...</div>
            </div>
            <div class="session-list" id="session-list">
                <!-- Sessions will be loaded here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-area">
                <div class="meta" id="session-info" style="padding: 20px; text-align: center; color: #888;">
                    Select a session from the sidebar to view execution details
                </div>

                <div id="error-container"></div>

                <div id="content" class="hidden">
        <div class="stats" id="stats">
            <div class="stat-item">
                <span class="label">Events:</span>
                <span class="value" id="total-events">-</span>
            </div>
            <div class="stat-item">
                <span class="label">Responses:</span>
                <span class="value" id="response-nodes">-</span>
            </div>
            <div class="stat-item">
                <span class="label">Helpers:</span>
                <span class="value" id="helper-nodes">-</span>
            </div>
            <div class="stat-item">
                <span class="label">Duration:</span>
                <span class="value" id="total-duration">-</span>
            </div>
            <div class="stat-item">
                <span class="label">Tokens:</span>
                <span class="value" id="total-tokens">-</span>
            </div>
            <div class="stat-item">
                <span class="label">Files:</span>
                <span class="value" id="file-count">-</span>
            </div>
            <div class="stat-item">
                <span class="label">Errors:</span>
                <span class="value" id="error-count">-</span>
            </div>
        </div>

        <div class="table-container">
            <div class="table-scroll">
                <table class="execution-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Node</th>
                            <th>Status</th>
                            <th>Usage</th>
                            <th>Content</th>
                            <th>Output</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #888; padding: 40px;">
                                Load a session to view execution details
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let sessionData = [];
        let nodesMap = new Map();
        let currentSessionPath = '';
        let sessionBasePath = '';
        let sessionFiles = []; // List of all files in session

        async function loadSession() {
            const sessionId = document.getElementById('session-path').value.trim();
            if (!sessionId) {
                showError('Please enter a session ID');
                return;
            }

            const homeDir = await getHomeDir();
            sessionBasePath = `file://${homeDir}/.local/state/sabre/logs/sessions/${sessionId}`;
            currentSessionPath = sessionId;

            try {
                await loadSessionData();
                document.getElementById('content').classList.remove('hidden');
                document.getElementById('error-container').innerHTML = '';
            } catch (error) {
                showError(`Failed to load session: ${error.message}`);
            }
        }

        async function getHomeDir() {
            // Try to detect home directory
            const paths = [
                '/Users/raghu',  // macOS
                '/home/' + (navigator.userAgent.includes('Linux') ? 'user' : 'raghu')
            ];
            return paths[0];  // Default to macOS path
        }

        async function loadSessionData() {
            const apiUrl = `http://localhost:8011/v1/sessions/${currentSessionPath}`;

            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const text = await response.text();
            const lines = text.trim().split('\n');

            sessionData = lines.map(line => JSON.parse(line));

            // Load files list
            try {
                const filesResponse = await fetch(`http://localhost:8011/v1/sessions/${currentSessionPath}/files`);
                if (filesResponse.ok) {
                    const filesData = await filesResponse.json();
                    sessionFiles = filesData.files.filter(f => f.type === 'image');
                    console.log(`Loaded ${sessionFiles.length} image files for session`);
                }
            } catch (error) {
                console.warn('Failed to load session files:', error);
                sessionFiles = [];
            }

            // Update session info
            const sessionStart = sessionData.find(e => e.event_type === 'session_start');
            if (sessionStart) {
                document.getElementById('session-info').innerHTML = `
                    Session ID: ${currentSessionPath}<br>
                    User Query: "${sessionStart.message}"
                `;
            }

            processSessionData();
            renderTable();
            updateStats();
        }

        function clearError() {
            const container = document.getElementById('error-container');
            container.innerHTML = '';
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                </div>
            `;
            document.getElementById('content').classList.add('hidden');
        }

        function processSessionData() {
            nodesMap.clear();
            sessionFiles = [];  // Reset files list

            sessionData.forEach(event => {
                if (event.node_id) {
                    if (!nodesMap.has(event.node_id)) {
                        nodesMap.set(event.node_id, {
                            id: event.node_id,
                            parent_id: event.parent_id,
                            depth: event.depth,
                            type: event.node_type || event.event_type,
                            conversation_id: event.conversation_id,
                            events: [],
                            children: [],
                            files: []  // Track files saved by this node
                        });
                    }
                    nodesMap.get(event.node_id).events.push(event);
                }
            });

            // Process file_saved events and associate with nodes
            const fileSavedEvents = sessionData.filter(e => e.event_type === 'file_saved');
            console.log(`Found ${fileSavedEvents.length} file_saved events`);

            fileSavedEvents.forEach(fileEvent => {
                // file_saved events don't have node_id, so we need to associate them
                // with the most recent active node or show them separately
                // For now, let's add them to a global files list
                sessionFiles.push({
                    filename: fileEvent.filename,
                    file_path: fileEvent.file_path,
                    file_type: fileEvent.file_type,
                    context: fileEvent.context,
                    metadata: fileEvent.metadata,
                    timestamp: fileEvent.timestamp
                });
            });

            // Build tree relationships
            nodesMap.forEach(node => {
                if (node.parent_id && nodesMap.has(node.parent_id)) {
                    nodesMap.get(node.parent_id).children.push(node.id);
                }
            });
        }

        function renderTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            // Find root nodes and flatten tree
            const rootNodes = Array.from(nodesMap.values()).filter(n => !n.parent_id);
            const rows = [];

            rootNodes.forEach(node => {
                flattenNode(node, 0, rows, true);
            });

            // Create table rows
            rows.forEach((rowData, index) => {
                const tr = document.createElement('tr');
                tr.className = `depth-${Math.min(rowData.depth, 3)}`;
                tr.innerHTML = createTableRow(rowData, index, rows);
                tableBody.appendChild(tr);
            });
        }

        function flattenNode(node, depth, rows, isLast) {
            const hasChildren = node.children && node.children.length > 0;
            rows.push({ node, depth, isLast, hasChildren });

            if (hasChildren) {
                node.children.forEach((childId, index) => {
                    const childNode = nodesMap.get(childId);
                    if (childNode) {
                        const isLastChild = index === node.children.length - 1;
                        flattenNode(childNode, depth + 1, rows, isLastChild);
                    }
                });
            }
        }

        function createTableRow(rowData, index, rows) {
            const { node, depth, isLast } = rowData;
            const nodeData = nodesMap.get(node.id);
            const startEvent = nodeData.events.find(e => e.event_type === 'node_start' || e.event_type === 'user_message');
            const completeEvent = nodeData.events.find(e => e.event_type === 'node_complete');
            const assistantMsg = nodeData.events.find(e => e.event_type === 'assistant_message');
            const outputs = nodeData.events.filter(e => e.event_type === 'node_output');

            // Timestamp
            const timestamp = startEvent ? new Date(startEvent.timestamp).toLocaleTimeString() : '-';

            // Node cell with tree connectors
            const typeLabel = nodeData.type === 'user_message' ? 'user' : nodeData.type;

            // Build tree connectors
            let treeHtml = '';
            if (depth > 0) {
                // Add connectors for each level
                for (let i = 0; i < depth; i++) {
                    if (i === depth - 1) {
                        // Last level - show L-shape connector
                        treeHtml += `<div class="tree-connector"></div>`;
                    } else {
                        // Parent levels - show spacing
                        treeHtml += `<div style="width: 20px; height: 30px;"></div>`;
                    }
                }
            }

            const nodeCell = `
                <div class="node-cell">
                    ${treeHtml}
                    <span class="node-type-badge ${typeLabel}">${typeLabel}</span>
                    <span class="node-id">${node.id.substring(0, 8)}</span>
                </div>
            `;

            // Status
            let statusCell = '-';
            if (completeEvent) {
                const status = completeEvent.status || 'success';
                statusCell = `<span class="status-badge ${status}">${status}</span>`;
            }

            // Usage (tokens + duration)
            let usageCell = '-';
            if (completeEvent) {
                const duration = (completeEvent.duration_ms / 1000).toFixed(2);
                let totalTokens = 0;
                if (completeEvent.tokens) {
                    totalTokens = (completeEvent.tokens.input || 0) +
                                 (completeEvent.tokens.output || 0) +
                                 (completeEvent.tokens.reasoning || 0);
                }
                usageCell = `
                    <div class="usage-cell">
                        <div><span class="usage-label">Time:</span> <span class="usage-value">${duration}s</span></div>
                        ${totalTokens > 0 ? `<div><span class="usage-label">Tokens:</span> <span class="usage-value">${(totalTokens / 1000).toFixed(1)}k</span></div>` : ''}
                    </div>
                `;
            }

            // Content (message or helper code)
            let contentCell = '';
            if (startEvent?.message) {
                contentCell = `<div class="content-cell">${escapeHtml(startEvent.message)}</div>`;
            } else if (assistantMsg) {
                contentCell = `<div class="content-cell">${escapeHtml(assistantMsg.content)}</div>`;
            } else if (startEvent?.metadata?.code) {
                contentCell = `<div class="content-cell"><div class="code-content">${escapeHtml(startEvent.metadata.code)}</div></div>`;
            }

            // Add system prompt if available (for response and llm_call nodes)
            if (startEvent?.system_prompt && (startEvent.node_type === 'response' || startEvent.node_type === 'llm_call')) {
                const promptPreview = startEvent.system_prompt.substring(0, 100) + '...';
                const promptId = `prompt-${node.id}`;
                const promptHtml = `
                    <details class="system-prompt-section">
                        <summary class="system-prompt-summary">
                            <span class="prompt-label">System Prompt</span>
                            <span class="prompt-preview">${escapeHtml(promptPreview)}</span>
                        </summary>
                        <div class="system-prompt-content">${escapeHtml(startEvent.system_prompt)}</div>
                    </details>
                `;
                contentCell = contentCell ? `${contentCell}${promptHtml}` : `<div class="content-cell">${promptHtml}</div>`;
            }

            // Output
            let outputCell = '';

            // Check for files saved during this time period (based on timestamp proximity)
            const nodeStartTime = startEvent ? new Date(startEvent.timestamp) : null;
            const nodeEndTime = completeEvent ? new Date(completeEvent.timestamp) : null;

            let nodeFiles = [];
            if (nodeStartTime && nodeEndTime) {
                // Find files saved during this node's execution window
                nodeFiles = sessionFiles.filter(file => {
                    const fileTime = new Date(file.timestamp);
                    return fileTime >= nodeStartTime && fileTime <= nodeEndTime;
                });
            }

            // Render files from file_saved events
            let imageHtmls = nodeFiles
                .filter(file => file.file_type === 'image')
                .map(file => {
                    const imagePath = `http://localhost:8011/v1/sessions/${currentSessionPath}/files/${file.filename}`;
                    const context = file.context || 'unknown';
                    const helperName = file.metadata?.helper_name || '';
                    const caption = helperName ? `${context} (${helperName})` : context;
                    return `<div class="screenshot-container">
                        <div style="font-size: 10px; color: #888; margin-bottom: 5px;">${caption}</div>
                        <img src="${imagePath}" alt="${file.filename}" class="screenshot-image" title="${file.filename}" />
                    </div>`;
                });

            // Also check for helpers_execution_end event with result images (legacy support)
            const helpersEndEvent = nodeData.events.find(e => e.event_type === 'helpers_execution_end');

            if (helpersEndEvent && helpersEndEvent.data && helpersEndEvent.data.result) {
                // Extract ImageContent objects from result
                helpersEndEvent.data.result.forEach(contentItem => {
                    if (contentItem.type === 'image' && contentItem.data && contentItem.data.image) {
                        const imageUrl = contentItem.data.image;
                        // Convert localhost URL to relative path or use as-is
                        const imagePath = imageUrl.startsWith('http://localhost')
                            ? imageUrl
                            : `http://localhost:8011/v1/sessions/${currentSessionPath}/files/${imageUrl}`;
                        // Only add if not already in imageHtmls (avoid duplicates)
                        const alreadyRendered = imageHtmls.some(html => html.includes(imagePath));
                        if (!alreadyRendered) {
                            imageHtmls.push(`<div class="screenshot-container"><img src="${imagePath}" alt="Helper result" class="screenshot-image" /></div>`);
                        }
                    }
                });
            }

            if (outputs.length > 0) {
                const outputDivs = outputs.map(output => {
                    const isError = output.output_type === 'stderr';
                    const className = isError ? 'error-content' : 'output-content';
                    let content = escapeHtml(output.content);

                    // Check for image files mentioned in output and render them inline
                    // This will show images in the row where they're actually referenced
                    const imageMatches = content.match(/[\w\-]+\.(png|jpg|jpeg|gif|webp)/gi);
                    if (imageMatches) {
                        imageMatches.forEach(imageName => {
                            const imagePath = `http://localhost:8011/v1/sessions/${currentSessionPath}/files/${imageName}`;
                            const imageHtml = `<div class="screenshot-container"><img src="${imagePath}" alt="${imageName}" class="screenshot-image" /></div>`;
                            content = content.replace(imageName, imageHtml);
                        });
                    }

                    return `<div class="${className}">${content}</div>`;
                }).join('');
                outputCell = `<div class="output-cell">${outputDivs}${imageHtmls.join('')}</div>`;
            } else if (imageHtmls.length > 0) {
                // Only images, no text output
                outputCell = `<div class="output-cell">${imageHtmls.join('')}</div>`;
            }

            return `
                <td>${timestamp}</td>
                <td>${nodeCell}</td>
                <td>${statusCell}</td>
                <td>${usageCell}</td>
                <td>${contentCell}</td>
                <td>${outputCell}</td>
            `;
        }

        function updateStats() {
            const responseNodes = sessionData.filter(e => e.event_type === 'node_start' && e.node_type === 'response').length;
            const helperNodes = sessionData.filter(e => e.event_type === 'node_start' && e.node_type === 'helper').length;
            const errors = sessionData.filter(e => e.event_type === 'node_complete' && e.status === 'error').length;

            const completedNodes = sessionData.filter(e => e.event_type === 'node_complete');
            const totalDuration = completedNodes.reduce((sum, e) => sum + (e.duration_ms || 0), 0);
            const totalTokens = completedNodes.reduce((sum, e) => {
                if (e.tokens) {
                    return sum + (e.tokens.input || 0) + (e.tokens.output || 0) + (e.tokens.reasoning || 0);
                }
                return sum;
            }, 0);

            const fileCount = sessionFiles.length;

            document.getElementById('total-events').textContent = sessionData.length;
            document.getElementById('response-nodes').textContent = responseNodes;
            document.getElementById('helper-nodes').textContent = helperNodes;
            document.getElementById('error-count').textContent = errors;
            document.getElementById('total-duration').textContent = (totalDuration / 1000).toFixed(2) + 's';
            document.getElementById('total-tokens').textContent = totalTokens.toLocaleString();
            document.getElementById('file-count').textContent = fileCount;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load sessions list on page load
        async function loadSessionsList() {
            try {
                const response = await fetch('/v1/sessions');
                const data = await response.json();
                const sessions = data.sessions || [];

                document.getElementById('session-count').textContent = `${sessions.length} sessions`;

                const sessionList = document.getElementById('session-list');
                if (sessions.length === 0) {
                    sessionList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No sessions found</div>';
                    return;
                }

                sessionList.innerHTML = sessions.map(session => `
                    <div class="session-item" onclick="loadSessionById('${session.session_id}')">
                        <div class="session-item-time">${new Date(session.start_time).toLocaleString()}</div>
                        <div class="session-item-preview">${session.preview || 'No preview'}</div>
                        <div class="session-item-id">${session.session_id}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load sessions list:', error);
                document.getElementById('session-count').textContent = 'Error loading sessions';
            }
        }

        // Load a specific session by ID
        function loadSessionById(sessionId) {
            // Remove active class from all items
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to clicked item
            event.target.closest('.session-item').classList.add('active');

            // Load the session
            currentSessionPath = sessionId;
            loadSession();
        }

        // Modified loadSession to use currentSessionPath
        async function loadSession() {
            const sessionId = currentSessionPath;
            if (!sessionId) {
                showError('Please select a session');
                return;
            }

            try {
                clearError();

                // Fetch session data
                const response = await fetch(`/v1/sessions/${sessionId}`);
                if (!response.ok) {
                    throw new Error(`Failed to load session: ${response.statusText}`);
                }

                const text = await response.text();
                const lines = text.trim().split('\n');
                sessionData = lines.map(line => JSON.parse(line));

                // Update session metadata
                const firstEvent = sessionData[0];
                const lastEvent = sessionData[sessionData.length - 1];
                document.getElementById('session-info').innerHTML = `
                    <strong>${sessionId}</strong> &bull;
                    ${new Date(firstEvent.timestamp).toLocaleString()} - ${new Date(lastEvent.timestamp).toLocaleString()}
                `;

                sessionBasePath = sessionId;
                processSessionData();
                renderTable();
                updateStats();
                document.getElementById('content').classList.remove('hidden');
            } catch (error) {
                showError(error.message);
                console.error('Error loading session:', error);
            }
        }

        // Auto-load sessions list on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSessionsList();
        });
    </script>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
